<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Binance Futures Collector </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 0; padding: 16px; background: #0b0f14; color: #e6edf3; }
  .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 16px; padding: 16px; max-width: 980px; margin: 0 auto; }
  input, button { padding: 10px 16px; border-radius: 8px; border: 1px solid #334155; background: #0b1220; color:#e6edf3 }
  button.primary { background:#0ea5e9; color:#0b0f14; font-weight:600 }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  .log { background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:12px; height:320px; overflow:auto; white-space:pre; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
</style>
</head>
<body>
<div class="card">
  <h2 style="margin-top:0">Binance Futures Collector â€” Save NDJSON </h2>
  <div class="row">
    <div>
      <label>Symbols (comma-separated, lowercase)</label>
      <input id="symbols" value="btcusdt,ethusdt">
    </div>
    <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
      <button id="start" class="primary">Start</button>
      <button id="stop">Stop</button>
      <button id="download">Download NDJSON</button>
      <button id="clear">Clear</button>
    </div>
  </div>
  <p id="stats">Buffered: 0</p>
  <div class="log" id="log"></div>
</div>
<script>
(()=>{
  const $=id=>document.getElementById(id);
  let sockets=[], buffer=[], running=false;
  let fastapiWS = null;

  // --- Connect to FastAPI WebSocket backend ---
  function connectFastAPI(){
    try {
      fastapiWS = new WebSocket("ws://localhost:8000/ws/from_tool");
      fastapiWS.onopen = ()=> log("[FastAPI] Connected to backend WebSocket");
      fastapiWS.onclose = ()=> log("[FastAPI] WebSocket closed");
      fastapiWS.onerror = ()=> log("[FastAPI] WebSocket error");
    } catch (err) {
      log("[FastAPI] Connection failed: " + err.message);
    }
  }

  // --- Helper functions ---
  function log(m){ 
    const ts=new Date().toISOString(); 
    $('log').textContent+=`[${ts}] ${m}\n`; 
    $('log').scrollTop=$('log').scrollHeight; 
  }
  function update(){ $('stats').textContent = `Buffered: ${buffer.length}`; }
  function normalize(j){ 
    const ts=new Date(j.T||j.E).toISOString(); 
    return {symbol:j.s, ts, price:Number(j.p), size:Number(j.q)}; 
  }

  // --- Start collecting Binance data ---
  $('start').onclick=()=>{
    if(running) return; 
    running=true;
    const syms=$('symbols').value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    if(!syms.length){ log('No symbols'); return; }

    log("Starting collection for symbols: " + syms.join(", "));
    connectFastAPI();

    sockets=syms.map(sym=>{
      const url=`wss://fstream.binance.com/ws/${sym}@trade`;
      const ws=new WebSocket(url);

      ws.onopen=()=>log(`Connected to Binance WS: ${sym}`);

      ws.onmessage=(ev)=>{
        try{ 
          const j=JSON.parse(ev.data);
          if(j.e==='trade'){ 
            const normalized = normalize(j);
            buffer.push(normalized); 
            update(); 

            // Send to FastAPI backend if connected
            if(fastapiWS && fastapiWS.readyState === WebSocket.OPEN){
              fastapiWS.send(JSON.stringify(normalized));
            }
          } 
        }catch(e){
          console.error(e);
        } 
      };

      ws.onclose=(ev)=>log(`Binance WS closed ${sym} code=${ev.code}`);
      ws.onerror=(ev)=>log(`Binance WS error ${sym}`);
      return ws;
    });
  };

  // --- Stop collection ---
  $('stop').onclick=()=>{
    sockets.forEach(ws=>{ try{ ws.close(1000,'user stop'); }catch{} });
    sockets=[]; running=false; 
    log('Stopped collecting Binance data.');

    if(fastapiWS){
      fastapiWS.close(1000, "user stop");
      fastapiWS = null;
    }
  };

  // --- Download NDJSON file locally ---
  $('download').onclick=()=>{
    const ndjson=buffer.map(x=>JSON.stringify(x)).join('\n');
    const blob=new Blob([ndjson], {type:'application/x-ndjson'});
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob);
    const ts=new Date().toISOString().replaceAll(':','-'); 
    a.download=`ticks_${ts}.ndjson`;
    document.body.appendChild(a); 
    a.click(); 
    a.remove();
  };

  // --- Clear local buffer ---
  $('clear').onclick=()=>{ buffer=[]; update(); log('Cleared buffer.'); };

})();
</script>
</body>
</html>
